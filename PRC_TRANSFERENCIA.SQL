USE [DB_CLIENTE]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[PRC_FAT_TRANSFERENCIA] AS

--CARREGA BASE TEMPORARIA - TRANSFERENCIA PARA GERAR DADOS DE TRANSFERENCIA -- 
  
CREATE TABLE #TransferOne (
		ID int identity(1,1) primary key clustered,
		DT_DATA DATE,
		HR_HORA time(0),
		NM_PROGRAMA varchar(255),
		NM_CONVERSACAO varchar(255),
		NM_SEGMENTO varchar(255),
		NM_RESULTADO varchar(255),
		NR_SEGMENTO_RESPONDIDO_POR_EQUIPE int,
		NR_ID_AGENTE int,
		NM_AGENT_EMAIL varchar(255),
		NM_PROGRAMA_AGENT varchar(150)
)

INSERT INTO #TransferOne

   SELECT DT_DATA
         ,CONVERT(TIME(0), HR_HORA) HR_HORA
		 ,NM_PROGRAMA 
	    ,NM_CONVERSACAO
	    ,NM_SEGMENTO
	    ,NM_RESULTADO
	    ,CONVERT(INT, NR_SEGMENTOS_RESPONDIDO_POR_EQUIPE) AS NR_SEGMENTOS_RESPONDIDO_POR_EQUIPE
	    ,CONVERT(INT, NR_ID_AGENTE) NR_ID_AGENTE
		,NM_AGENTE_EMAIL
		,NM_AGENT_TEAM
    FROM TB_ODS_BASE_TRANSFERENCIA
ORDER BY DT_DATA
        ,NM_CONVERSACAO
		,HR_HORA
		,NM_SEGMENTO ASC -- CRIS PEDIU PRA ORDENAR SEGMENTO POR ULTIMO


--GERA SEGUNDA BASE DE DADOS TRANSFERENCIA PARA COMPARAÇÃO DE CONVERSAÇÃO COM A #TransferOne --

SELECT DT_DATA
      ,HR_HORA
	  ,NM_PROGRAMA
	  ,NM_CONVERSACAO
	  ,NM_SEGMENTO
	  ,NM_RESULTADO
	  ,NR_SEGMENTO_RESPONDIDO_POR_EQUIPE
	  ,NR_ID_AGENTE
	  ,NM_AGENT_EMAIL
	  ,NM_PROGRAMA_AGENT
	  ,ID AS NR_ID
  INTO #TransferTwo
  FROM #TransferOne
ORDER BY ID


-- GERA SEGUNDA BASE DE DADOS TRANSFERENCIA ORDENANDO POR NR_ID

SELECT DT_DATA
      ,HR_HORA
	  ,NM_PROGRAMA
	  ,NM_CONVERSACAO
	  ,NM_SEGMENTO
	  ,NM_RESULTADO
	  ,NR_SEGMENTO_RESPONDIDO_POR_EQUIPE
	  ,NR_ID_AGENTE
	  ,NM_AGENT_EMAIL
	  ,NM_PROGRAMA_AGENT
	  ,NR_ID
  INTO #TransferThree
  FROM #TransferTwo
ORDER BY NR_ID

-- 
SELECT DT_DATA
      ,HR_HORA
	  ,NM_PROGRAMA
	  ,NM_CONVERSACAO
	  ,NM_SEGMENTO
	  ,NM_RESULTADO
	  ,NR_SEGMENTO_RESPONDIDO_POR_EQUIPE
	  ,NR_ID_AGENTE
	  ,NM_AGENT_EMAIL
	  ,NM_PROGRAMA_AGENT
	  ,(NR_ID - 1) AS NR_ID
 INTO #TransferFour
 FROM #TransferThree
WHERE NR_ID > 1
ORDER BY NR_ID


SELECT A.DT_DATA
      ,A.HR_HORA
	  ,A.NM_PROGRAMA
	  ,A.NM_CONVERSACAO
	  ,A.NM_SEGMENTO
	  ,A.NM_RESULTADO
	  ,A.NR_SEGMENTO_RESPONDIDO_POR_EQUIPE
	  ,A.NR_ID_AGENTE
	  ,B.NM_CONVERSACAO AS NM_CONVERSACAO_B
	  ,B.NM_PROGRAMA AS NM_PROGRAMA_B
	  ,A.NM_AGENT_EMAIL
	  ,A.NM_PROGRAMA_AGENT
	  ,A.NR_ID
 INTO #TransferFive
 FROM #TransferThree A
 LEFT JOIN #TransferFour B
   ON A.NR_ID = B.NR_ID
 ORDER BY NR_ID

SELECT DT_DATA
       ,CONVERT(TIME(0), HR_HORA)  HR_INTERVALO
	   --,CONVERT(INT, LEFT(HR_HORA, 2)) HR_INTERVALO
	   ,NM_PROGRAMA
	   ,IIF(NM_RESULTADO = 'task transferred',1,0) NR_TRANSFERENCIA
	   ,IIF(NM_RESULTADO = 'task transferred', IIF(NM_CONVERSACAO = NM_CONVERSACAO_B, IIF(NM_PROGRAMA <> NM_PROGRAMA_B,1,0),0),0) NM_TRANSFERENCIA_DE_CELULA
	   ,IIF(NM_RESULTADO = 'task transferred', IIF(NM_CONVERSACAO = NM_CONVERSACAO_B, IIF(NM_PROGRAMA = NM_PROGRAMA_B,1,0),0),0) NM_TRANSFERENCIA_MESMA_CELULA
	   ,IIF(NM_RESULTADO = 'task idled',1,0) NR_INATIVO
	   ,IIF(NM_RESULTADO = 'completed',1,0) NR_COMPLETO
	   ,NR_ID_AGENTE
	   ,NM_CONVERSACAO
	   ,NM_SEGMENTO
	   ,NM_RESULTADO
	   ,A.NM_AGENT_EMAIL
	   ,A.NM_PROGRAMA_AGENT
	   ,IIF(NM_RESULTADO = 'task transferred', IIF(NM_CONVERSACAO = NM_CONVERSACAO_B, IIF(NM_PROGRAMA <> NM_PROGRAMA_B,NM_PROGRAMA_B,NM_PROGRAMA),NM_PROGRAMA),NM_PROGRAMA) NM_DESTINO

   INTO #TransferSix
   FROM #TransferFive A

DELETE 
  FROM TB_FAT_BASE_TRANSFERENCIA_NEW
 WHERE DT_DATA IN (SELECT DT_DATA FROM #TransferSix)

INSERT INTO TB_FAT_BASE_TRANSFERENCIA_NEW(DT_DATA
                                         ,HR_INTERVALO
										 ,NM_PROGRAMA
										 ,NR_TRANSFERENCIA
										 ,NM_TRANSFERENCIA_DE_CELULA
										 ,NM_TRANSFERENCIA_MESMA_CELULA
										 ,NR_INATIVO
										 ,NR_COMPLETO
										 ,NR_ID_AGENTE
										 ,NM_CONVERSACAO
										 ,NM_SEGMENTO
										 ,NR_RESULTADO
										 ,NM_AGENT_EMAIL
										 ,NM_AGENT_TEAM
										 ,NM_DESTINO
										) 

SELECT A.DT_DATA
       ,A.HR_INTERVALO
	   ,A.NM_PROGRAMA
	   ,A.NR_TRANSFERENCIA
	   ,A.NM_TRANSFERENCIA_DE_CELULA
	   ,A.NM_TRANSFERENCIA_MESMA_CELULA
	   ,A.NR_INATIVO
	   ,A.NR_COMPLETO
	   ,A.NR_ID_AGENTE
	   ,A.NM_CONVERSACAO
	   ,A.NM_SEGMENTO
	   ,A.NM_RESULTADO
	   ,a.NM_AGENT_EMAIL
	   ,a.NM_PROGRAMA_AGENT
	   ,a.NM_DESTINO
  FROM #TransferSix A

DROP TABLE #TransferOne
DROP TABLE #TransferTwo
DROP TABLE #TransferThree
DROP TABLE #TransferFour
DROP TABLE #TransferFive
DROP TABLE #TransferSix

